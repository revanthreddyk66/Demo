def handler(event, context):

    # Step 1: Read request body
    body = json.loads(event["body"])
    op = body.get("operation", "grayscale")

    if "image_base64" in body:
        decode base64 → write to /tmp/in.jpg

    elif "url" in body:
        download image → write to /tmp/in.jpg

    else:
        return error

    # Step 2: Load with OpenCV
    img = cv2.imread("/tmp/in.jpg")

    # Step 3: Process
    if op == "grayscale":
        processed = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)
    elif op == "resize":
        processed = cv2.resize(img, (200, 200))
    else:
        processed = img

    # Step 4: Save output
    cv2.imwrite("/tmp/out.jpg", processed)

    # Step 5: Upload to S3
    key = "processed/" + unique_filename()
    s3.put_object(
        Bucket=OUTPUT_BUCKET,
        Key=key,
        Body=open("/tmp/out.jpg", "rb")
    )

    # Step 6: return URL
    url = f"https://{OUTPUT_BUCKET}.s3.amazonaws.com/{key}"
    return {"statusCode": 200, "body": json.dumps({"processed_image_url": url})}

